<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FGC Input Display ‚Ä¢ Editor Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --accent: #7c4dff;
    --accent-hover: #9965f4;
    --warning: #ffab00;
    --success: #00e676;
    --bg-app: #050505;
    --panel-bg: #0f0f13;       
    --surface: #1a1a20;        
    --surface-hover: #25252e;
    --text-main: #ffffff;
    --text-muted: #888899;
    --border-subtle: rgba(255,255,255,0.08);
    --hover-bg: rgba(124, 77, 255, 0.1); 
  }

  body {
    margin: 0;
    height: 100vh;
    background: var(--bg-app);
    overflow: hidden;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    color: var(--text-main);
    user-select: none;
  }

  /* --- Scrollbars Personalizados --- */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #555; }

  #canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  /* --- Botones circulares (Canvas) --- */
  .input-btn {
    position: absolute;
    border-radius: 50%;
    background: rgba(30, 30, 60, 0.9);
    border: 3px solid rgba(124, 77, 255, 0.6);
    color: white;
    font-weight: bold;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
    transition: transform 0.05s ease, box-shadow 0.05s ease, border-color 0.1s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.7);
    backdrop-filter: blur(10px);
    z-index: 10;
    background-size: 60%; /* Ajuste para iconos */
    background-repeat: no-repeat;
    background-position: center;
  }
  .input-btn:active { cursor: grabbing; }
  .input-btn.plain {
    background: rgba(50,50,60,0.95);
    border: 3px solid rgba(255,255,255,0.2);
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
  }
  .input-btn.selected-multi {
    border-color: #fff !important;
    box-shadow: 0 0 0 2px #fff, 0 0 20px var(--accent);
  }
  .input-btn.effect-down.active {
    transform: scale(0.92);
    box-shadow: inset 0 0 15px rgba(0,0,0,0.9);
    border-color: var(--accent);
    filter: brightness(1.2);
  }
  .input-btn.effect-up.active {
    transform: scale(1.2);
    box-shadow: 0 0 40px var(--accent);
    border-color: var(--accent);
    z-index: 1000;
  }

  .delete-badge {
    position: absolute;
    top: -5px; right: -5px;
    width: 24px; height: 24px;
    background: #ff4444;
    border: 2px solid white;
    border-radius: 50%;
    color: white;
    font-size: 14px;
    font-weight: bold;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    z-index: 2000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .input-btn.editing .delete-badge,
  .input-btn:hover .delete-badge { opacity: 1; pointer-events: auto; }

  #selectionBox {
    position: absolute;
    border: 1px solid rgba(124, 77, 255, 0.8);
    background: rgba(124, 77, 255, 0.2);
    display: none;
    z-index: 9999;
    pointer-events: none;
  }

  /* --- PANELES --- */
  #rightPanel, #leftPanel {
    position: fixed;
    top: 0; bottom: 0;
    background: var(--panel-bg);
    z-index: 9999;
    box-shadow: 0 0 50px rgba(0,0,0,0.8);
    transition: transform 0.4s cubic-bezier(0.22,1,0.36,1);
    display: flex;
    flex-direction: column;
  }
  #rightPanel { right: 0; width: 400px; transform: translateX(100%); border-left: 1px solid var(--border-subtle); }
  #leftPanel { left: 0; width: 360px; transform: translateX(-100%); border-right: 1px solid var(--border-subtle); }
  
  #rightPanel.open, #leftPanel.open { transform: translateX(0); }

  .panel-header {
    flex-shrink: 0;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 25px;
    background: rgba(15, 15, 19, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-subtle);
    z-index: 20;
  }
  .panel-header h2 { margin: 0; font-size: 20px; font-weight: 600; color: var(--text-main); }
  .panel-header .subtitle { display: block; font-size: 12px; color: var(--text-muted); font-weight: 400; margin-top: 2px; }
  
  .btn-close-panel {
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-size: 24px;
    cursor: pointer;
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    padding: 0; margin: 0;
  }
  .btn-close-panel:hover { background: rgba(255,255,255,0.1); color: white; }

  .panel-scroll {
    flex-grow: 1;
    overflow-y: auto;
    padding: 25px;
    position: relative; 
  }

  /* --- EFECTO HOVER SLIDE --- */
  .hover-glow {
    position: absolute;
    background: var(--hover-bg);
    border-radius: 16px;
    pointer-events: none;
    z-index: 5;
    opacity: 0;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* --- TARJETAS --- */
  .control-card {
    background: var(--surface);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    border: 1px solid var(--border-subtle);
    transition: border-color 0.2s;
    position: relative;
    z-index: 10;
  }
  .control-card:hover { border-color: rgba(255,255,255,0.15); }
  .control-card h3 {
    margin: 0 0 15px 0;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    font-weight: 700;
  }

  /* --- INPUTS --- */
  label { display: block; font-size: 13px; color: #ccc; margin-bottom: 6px; margin-top: 12px; }
  .control-card label:first-of-type { margin-top: 0; }
  .input-group { position: relative; margin-bottom: 10px; }
  
  input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 10px 0;
    background: transparent;
    border: none;
    border-bottom: 2px solid #333;
    color: white;
    font-size: 15px;
    font-family: inherit;
    border-radius: 0;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }

  /* 1. Mejora: Estilizaci√≥n de Selects */
  select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    padding-right: 30px;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
  select option {
    background: var(--panel-bg);
    color: white;
    padding: 10px;
  }
  
  input[type="text"]:focus, input[type="number"]:focus, select:focus {
    outline: none;
    border-bottom-color: var(--accent);
  }
  
  button.action-btn {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
    z-index: 10;
    position: relative;
  }
  button.action-btn:hover { background: var(--accent-hover); box-shadow: 0 4px 12px rgba(124, 77, 255, 0.3); }
  button.action-btn:active { transform: scale(0.98); }
  
  button.secondary-btn { background: rgba(255,255,255,0.05); color: #ccc; }
  button.secondary-btn:hover { background: rgba(255,255,255,0.1); color: white; }
  button.danger-btn { background: rgba(255, 68, 68, 0.15); color: #ff4444; }
  button.danger-btn:hover { background: rgba(255, 68, 68, 0.25); }

  .toggle-row { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; }
  .toggle-row label { margin: 0; cursor: default; flex-grow: 1; }
  
  .tabs-container { display: flex; background: #111; border-radius: 10px; padding: 4px; margin-bottom: 25px; border: 1px solid #222; position: relative; z-index: 20; }
  .tab-btn { flex: 1; padding: 8px; background: transparent; color: #888; border: none; cursor: pointer; border-radius: 7px; font-size: 13px; font-weight: 600; transition: all 0.2s; }
  .tab-btn.active { background: #2a2a2a; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
  
  .flex-row { display: flex; gap: 10px; margin-top: 5px; align-items: flex-end; }
  .color-picker-wrapper { display: flex; align-items: center; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 4px; border: 1px solid var(--border-subtle); height: 38px; box-sizing: border-box; }
  input[type="color"] { width: 30px; height: 24px; border: none; padding: 0; background: none; cursor: pointer; border-radius: 4px; }
  
  .panel-page { display: none; animation: fadeIn 0.3s ease; }
  .panel-page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  #fab {
    position: fixed; bottom: 30px; right: 30px;
    width: 60px; height: 60px;
    background: var(--accent);
    border-radius: 50%;
    display: grid; place-items: center;
    font-size: 28px; cursor: pointer; color: white;
    box-shadow: 0 10px 30px rgba(124,77,255,0.4);
    z-index: 9998;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  #fab:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 15px 35px rgba(124,77,255,0.6); }

  #inputDisplayContainer {
    position: fixed;
    width: 300px;
    background: rgba(0, 0, 0, 0.85);
    border-radius: 10px;
    border-left: 4px solid var(--accent);
    padding: 10px;
    z-index: 50;
    cursor: grab;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    display: none;
    user-select: none;
  }
  
  .history-row { display: flex; align-items: center; justify-content: flex-start; height: 38px; margin-bottom: 2px; position: relative; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .history-row::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 1px; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); }
  .frame-count { font-family: 'Consolas', monospace; font-size: 12px; color: #ffffff; width: 30px; text-align: right; margin-right: 8px; flex-shrink: 0; }
  .input-icon { width: 32px; height: 32px; margin-right: 2px; display: flex; align-items: center; justify-content: center; }
  .input-icon img { width: 100%; height: 100%; object-fit: contain; }
  .fallback-icon { background: #333; color: #fff; border-radius: 4px; padding: 2px 6px; font-size: 14px; font-weight: bold; border: 1px solid #555; min-width: 18px; text-align: center; }
  
  button.learning { background: var(--warning); color: #000; animation: pulse 1s infinite; }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

  #globalGamepadStatus { font-size: 12px; color: #888; text-align: center; margin-top: 5px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px dashed #333; }
  #globalGamepadStatus.connected { color: var(--success); border: 1px solid var(--success); background: rgba(0,230,118,0.05); }
  
  #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e1e24; color: white; padding: 12px 24px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 1px solid #333; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 10000; display: flex; align-items: center; gap: 10px; font-size: 14px; }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(5px); }
  .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); }

  .combo-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-top: 10px; position: relative; border: 1px solid #333; }
  .combo-keys { font-size: 12px; font-weight: bold; color: var(--accent); margin-bottom: 5px; }
  .combo-delete { position: absolute; top: 5px; right: 5px; color: #ff4444; cursor: pointer; font-weight: bold; padding: 2px 6px; }

  /* NEO TOGGLE STYLES */
  .neo-toggle-container { --toggle-width: 80px; --toggle-height: 38px; --toggle-bg: #181c20; --toggle-off-color: #475057; --toggle-on-color: #36f9c7; --toggle-transition: 0.4s cubic-bezier(0.25, 1, 0.5, 1); position: relative; display: inline-flex; flex-direction: column; font-family: "Segoe UI", Tahoma, sans-serif; user-select: none; transform: scale(0.85); transform-origin: right center; }
  .neo-toggle-input { position: absolute; opacity: 0; width: 0; height: 0; }
  .neo-toggle { position: relative; width: var(--toggle-width); height: var(--toggle-height); display: block; cursor: pointer; transform: translateZ(0); perspective: 500px; }
  .neo-track { position: absolute; inset: 0; border-radius: calc(var(--toggle-height) / 2); overflow: hidden; transform-style: preserve-3d; transform: translateZ(-1px); transition: transform var(--toggle-transition); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.1); }
  .neo-background-layer { position: absolute; inset: 0; background: var(--toggle-bg); background-image: linear-gradient(-45deg, rgba(20, 20, 20, 0.8) 0%, rgba(30, 30, 30, 0.3) 50%, rgba(20, 20, 20, 0.8) 100%); opacity: 1; transition: all var(--toggle-transition); }
  .neo-grid-layer { position: absolute; inset: 0; background-image: linear-gradient(to right, rgba(71, 80, 87, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(71, 80, 87, 0.05) 1px, transparent 1px); background-size: 5px 5px; opacity: 0; transition: opacity var(--toggle-transition); }
  .neo-track-highlight { position: absolute; inset: 1px; border-radius: calc(var(--toggle-height) / 2); background: linear-gradient(90deg, transparent, rgba(54, 249, 199, 0)); opacity: 0; transition: all var(--toggle-transition); }
  .neo-spectrum-analyzer { position: absolute; bottom: 6px; right: 10px; height: 10px; display: flex; align-items: flex-end; gap: 2px; opacity: 0; transition: opacity var(--toggle-transition); }
  .neo-spectrum-bar { width: 2px; height: 3px; background-color: var(--toggle-on-color); opacity: 0.8; }
  .neo-thumb { position: absolute; top: 4px; left: 4px; width: 30px; height: 30px; border-radius: 50%; transform-style: preserve-3d; transition: transform var(--toggle-transition); z-index: 1; }
  .neo-thumb-ring { position: absolute; inset: 0; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.1); background: var(--toggle-off-color); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); transition: all var(--toggle-transition); }
  .neo-thumb-core { position: absolute; inset: 5px; border-radius: 50%; background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent); transition: all var(--toggle-transition); overflow: hidden; display: flex; align-items: center; justify-content: center; }
  .neo-thumb-icon { position: relative; width: 10px; height: 10px; transition: all var(--toggle-transition); }
  .neo-thumb-wave { position: absolute; top: 50%; left: 50%; width: 10px; height: 2px; background: var(--toggle-off-color); transform: translate(-50%, -50%); transition: all var(--toggle-transition); }
  .neo-thumb-pulse { position: absolute; inset: 0; border-radius: 50%; border: 1px solid var(--toggle-off-color); transform: scale(0); opacity: 0; transition: all var(--toggle-transition); }
  .neo-gesture-area { position: absolute; inset: -10px; z-index: 0; }
  .neo-interaction-feedback { position: absolute; inset: 0; pointer-events: none; z-index: 0; }
  .neo-ripple { position: absolute; top: 50%; left: 30%; width: 0; height: 0; border-radius: 50%; background: radial-gradient(circle, var(--toggle-on-color) 0%, transparent 70%); transform: translate(-50%, -50%); opacity: 0; transition: all 0.4s ease-out; }
  .neo-progress-arc { position: absolute; top: 50%; left: 50%; width: 80px; height: 80px; border-radius: 50%; border: 2px solid transparent; border-top-color: var(--toggle-on-color); transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 0; transition: opacity 0.3s ease, transform 0.5s ease; }
  .neo-status { position: absolute; bottom: -20px; left: 0; width: 100%; display: flex; justify-content: center; }
  .neo-status-indicator { display: flex; align-items: center; gap: 4px; }
  .neo-status-dot { width: 6px; height: 6px; border-radius: 50%; background-color: var(--toggle-off-color); transition: all var(--toggle-transition); }
  .neo-status-text { font-size: 9px; font-weight: 600; color: var(--toggle-off-color); letter-spacing: 1px; transition: all var(--toggle-transition); }
  .neo-value-display { position: absolute; top: -22px; right: 0; font-size: 12px; font-weight: 500; color: var(--toggle-off-color); opacity: 0; transform: translateY(5px); transition: all var(--toggle-transition); }
  .neo-toggle-input:checked + .neo-toggle .neo-thumb { transform: translateX(calc(var(--toggle-width) - 38px)); }
  .neo-toggle-input:checked + .neo-toggle .neo-thumb-ring { background-color: var(--toggle-on-color); border-color: rgba(54, 249, 199, 0.3); box-shadow: 0 0 15px rgba(54, 249, 199, 0.5); }
  .neo-toggle-input:checked + .neo-toggle .neo-thumb-wave { height: 8px; width: 8px; border-radius: 50%; background: transparent; border: 1px solid #fff; }
  .neo-toggle-input:checked + .neo-toggle .neo-thumb-pulse { transform: scale(1.2); opacity: 0.3; animation: neo-pulse 1.5s infinite; }
  .neo-toggle-input:checked + .neo-toggle .neo-track-highlight { background: linear-gradient(90deg, transparent, rgba(54, 249, 199, 0.2)); opacity: 1; }
  .neo-toggle-input:checked + .neo-toggle .neo-grid-layer { opacity: 1; }
  .neo-toggle-input:checked + .neo-toggle .neo-spectrum-analyzer { opacity: 1; }
  @keyframes neo-pulse { 0% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.5); opacity: 0.2; } 100% { transform: scale(1); opacity: 0.5; } }
  @keyframes neo-spectrum { 0% { height: 3px; } 50% { height: 8px; } 100% { height: 3px; } }
  .neo-toggle-input:checked + .neo-toggle .neo-spectrum-bar:nth-child(1) { animation: neo-spectrum 0.9s infinite; }
  .neo-toggle-input:checked + .neo-toggle .neo-spectrum-bar:nth-child(2) { animation: neo-spectrum 0.8s 0.1s infinite; }
  .neo-toggle-input:checked + .neo-toggle .neo-spectrum-bar:nth-child(3) { animation: neo-spectrum 1.1s 0.2s infinite; }
  .neo-toggle-input:checked + .neo-toggle .neo-spectrum-bar:nth-child(4) { animation: neo-spectrum 0.7s 0.1s infinite; }
  .neo-toggle-input:checked + .neo-toggle .neo-spectrum-bar:nth-child(5) { animation: neo-spectrum 0.9s 0.15s infinite; }
  .neo-toggle-input:checked + .neo-toggle .neo-status-dot { background-color: var(--toggle-on-color); box-shadow: 0 0 8px var(--toggle-on-color); }
  .neo-toggle-input:checked + .neo-toggle .neo-status-text::before { content: "ACTIVE"; color: var(--toggle-on-color); }
  .neo-toggle-input:not(:checked) + .neo-toggle .neo-status-text::before { content: "STANDBY"; }
</style>
</head>
<body>

<div id="canvas"></div>
<div id="selectionBox"></div>
<div id="toast"><div class="dot"></div><span id="toastMsg">Mensaje</span></div>

<div id="inputDisplayContainer"></div>

<div id="rightPanel">
  <div class="panel-header">
      <div>
        <h2>Configuraci√≥n</h2>
        <span class="subtitle">Editor Pro ‚Ä¢ 100% Custom</span>
      </div>
      <button class="btn-close-panel" onclick="closeRightPanel()">√ó</button>
  </div>

  <div class="panel-scroll">
    <div id="glow-right" class="hover-glow"></div>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchRightTab('general')" id="tab-general">General</button>
        <button class="tab-btn" onclick="switchRightTab('viewer')" id="tab-viewer">Viewer</button>
    </div>

    <div id="page-general" class="panel-page active">
        
        <button class="action-btn" onclick="addNewButton()">+ A√±adir Bot√≥n</button>

        <div class="control-card" style="margin-top:20px;">
            <h3>Apariencia Global</h3>
            <div class="input-group">
                <label>Fondo de Pantalla</label>
                <!-- 2. Mejora: Selector de Color para Fondo -->
                <div class="flex-row">
                    <div class="color-picker-wrapper">
                        <input type="color" id="bgInputPicker" value="#050505" oninput="syncBgPicker(this.value)">
                    </div>
                    <input type="text" id="bgInput" value="transparent" placeholder="#000000 o URL" style="flex:2;" oninput="syncBgText(this.value)">
                </div>
            </div>
            <div class="input-group">
                <label>Estilo de Botones</label>
                <select id="globalStyle" onchange="applyGlobalStyle()">
                    <option value="glass">Glassmorphism + Glow</option>
                    <option value="plain">Plano Minimalista</option>
                </select>
            </div>
        </div>

        <div class="control-card">
            <h3>L√≥gica de Inputs</h3>
            <div class="toggle-row">
                <div>
                    <label>SOCD Cleaning (Neutro)</label>
                    <div style="font-size:11px; color:#666; margin-top:2px;">Cancela Izq+Der y Arr+Aba</div>
                </div>
                <div class="neo-toggle-container">
                    <input class="neo-toggle-input" id="socdToggle" type="checkbox" onchange="saveSOCDConfig(); event.stopPropagation();" />
                    <label class="neo-toggle" for="socdToggle">
                        <div class="neo-track"><div class="neo-background-layer"></div><div class="neo-grid-layer"></div><div class="neo-spectrum-analyzer"><div class="neo-spectrum-bar"></div><div class="neo-spectrum-bar"></div><div class="neo-spectrum-bar"></div><div class="neo-spectrum-bar"></div><div class="neo-spectrum-bar"></div></div><div class="neo-track-highlight"></div></div>
                        <div class="neo-thumb"><div class="neo-thumb-ring"></div><div class="neo-thumb-core"><div class="neo-thumb-icon"><div class="neo-thumb-wave"></div><div class="neo-thumb-pulse"></div></div></div></div>
                        <div class="neo-gesture-area"></div><div class="neo-interaction-feedback"><div class="neo-ripple"></div><div class="neo-progress-arc"></div></div>
                        <div class="neo-status"><div class="neo-status-indicator"><div class="neo-status-dot"></div><div class="neo-status-text"></div></div></div>
                    </label>
                </div>
            </div>
        </div>

        <div class="control-card">
            <h3>Datos</h3>
            <div class="input-group">
                <label>Importar Config (JSON)</label>
                <input type="text" id="importInput" placeholder="Pegar c√≥digo JSON...">
            </div>
            <button class="action-btn secondary-btn" onclick="exportConfig()">Copiar Configuraci√≥n</button>
            <button class="action-btn danger-btn" onclick="clearAll()" style="margin-top:10px;">Resetear Todo</button>
        </div>
        
        <div id="globalGamepadStatus">Esperando mando...</div>
    </div>

    <div id="page-viewer" class="panel-page">
        <button class="action-btn secondary-btn" onclick="resetViewerPos()">Centrar Viewer en Pantalla</button>
        
        <div class="control-card" style="margin-top:20px;">
            <h3>Estilo del Viewer</h3>
            <label>Fondo</label>
            <div class="flex-row">
                <div class="color-picker-wrapper"><input type="color" id="viewerBgColorPicker" value="#000000" oninput="updateViewerBg(this.value)"><span style="font-size:12px; color:#aaa; margin-left: 4px;">Picker</span></div>
                <input type="text" id="viewerBgColorText" value="rgba(0,0,0,0.85)" oninput="updateViewerBg(this.value)" style="flex:2;">
            </div>
            <label style="margin-top:10px;">Borde Lateral</label>
            <div class="flex-row">
                <div class="color-picker-wrapper"><input type="color" id="viewerBorderColorPicker" value="#7c4dff" oninput="updateBorderColor(this.value)"><span style="font-size:12px; color:#aaa; margin-left: 4px;">Picker</span></div>
                <input type="text" id="viewerBorderColorText" value="#7c4dff" oninput="updateBorderColor(this.value)" style="flex:2;">
            </div>
        </div>

        <div class="control-card">
            <h3>Contador de Frames</h3>
            <div class="input-group"><label>Tama√±o Fuente (px)</label><input type="number" id="viewerFontSize" value="12" oninput="saveViewerConfig()"></div>
            <label>Color N√∫meros</label>
            <div class="flex-row">
                <div class="color-picker-wrapper"><input type="color" id="viewerFrameColorPicker" value="#ffffff" oninput="updateFrameColor(this.value)"></div>
                <input type="text" id="viewerFrameColorText" value="#ffffff" oninput="updateFrameColor(this.value)" style="flex:2;">
            </div>
            <div class="toggle-row" style="margin-top:15px;">
                <label>A√±adir Trazo Negro</label>
                <div class="neo-toggle-container">
                    <input class="neo-toggle-input" id="viewerFrameStroke" type="checkbox" onchange="saveViewerConfig(); event.stopPropagation();" checked />
                    <label class="neo-toggle" for="viewerFrameStroke"><div class="neo-track"><div class="neo-background-layer"></div><div class="neo-grid-layer"></div><div class="neo-spectrum-analyzer"><div class="neo-spectrum-bar"></div><div class="neo-spectrum-bar"></div><div class="neo-spectrum-bar"></div><div class="neo-spectrum-bar"></div><div class="neo-spectrum-bar"></div></div><div class="neo-track-highlight"></div></div><div class="neo-thumb"><div class="neo-thumb-ring"></div><div class="neo-thumb-core"><div class="neo-thumb-icon"><div class="neo-thumb-wave"></div><div class="neo-thumb-pulse"></div></div></div></div><div class="neo-gesture-area"></div><div class="neo-interaction-feedback"><div class="neo-ripple"></div><div class="neo-progress-arc"></div></div><div class="neo-status"><div class="neo-status-indicator"><div class="neo-status-dot"></div><div class="neo-status-text"></div></div></div></label>
                </div>
            </div>
        </div>

        <div class="control-card">
            <h3>Iconos Personalizados</h3>
            <div class="input-group"><label>Neutral (N)</label><input type="text" placeholder="URL Imagen" id="url_N" oninput="saveViewerConfig()"></div>
            <div id="attackUrlContainer"></div>
            <button class="action-btn secondary-btn" onclick="refreshAttackInputs()" style="font-size:12px; padding:8px;">Refrescar Lista</button>
        </div>

        <div class="control-card">
            <h3>Diagonales / Combos</h3>
            <p style="font-size:12px; color:#666; margin-bottom:10px;">Define combinaciones de 2 botones.</p>
            <div id="customCombosContainer"></div>
            <button class="action-btn" onclick="startComboLearning()">+ Crear Nueva Diagonal</button>
        </div>
    </div>
  </div>
</div>

<div id="leftPanel">
  <div class="panel-header">
      <div>
        <h2 id="editorTitle">Editar Bot√≥n</h2>
        <span class="subtitle">Propiedades</span>
      </div>
      <button class="btn-close-panel" onclick="closeEditor()">√ó</button>
  </div>

  <div class="panel-scroll">
    <div id="glow-left" class="hover-glow"></div>

    <div class="control-card">
        <h3>Identificaci√≥n</h3>
        <!-- 3. Mejora: Campo URL Icono -->
        <div class="input-group">
            <label>URL del Icono (Opcional)</label>
            <input type="text" id="editImage" placeholder="URL de imagen o icono..." oninput="updateCurrentButton()">
        </div>
        <div class="input-group"><label>Texto Visible</label><input type="text" id="editText" placeholder="Ej: LP" oninput="updateCurrentButton()"></div>
        <div class="input-group"><label>Tecla Teclado</label><input type="text" id="editKey" placeholder="Pulsa una tecla..." oninput="updateCurrentButton()"></div>
    </div>

    <div class="control-card">
        <h3>Input Viewer (Macro)</h3>
        <div class="input-group"><label>Botones que representa</label><input type="text" id="editMacro" placeholder="Ej: LP, MP" oninput="updateCurrentButton()"><p style="font-size:11px; color:#666; margin-top:4px;">Separa con comas. Deja vac√≠o para usar el Texto Visible.</p></div>
    </div>

    <div class="control-card">
        <h3>Mando / Gamepad</h3>
        <div id="gamepadStatusText" class="gamepad-status" style="margin-bottom:10px; font-size:13px; color:#aaa;">Ninguno asignado</div>
        <div style="display:flex; gap: 10px;"><button class="action-btn" id="btnAssignGamepad" onclick="startLearning()" style="margin-top:0;">Detectar</button><button class="action-btn secondary-btn" onclick="clearGamepadMapping()" style="width: 50px; margin-top:0;">üóëÔ∏è</button></div>
    </div>

    <div class="control-card">
        <h3>Estilo Visual</h3>
        <div class="input-group"><label>Tama√±o (px)</label><input type="number" id="editSize" value="80" oninput="updateCurrentButton()"></div>
        <label>Color Inactivo</label><div class="flex-row"><div class="color-picker-wrapper"><input type="color" id="colorInactive" value="#1e1e32" oninput="updateCurrentButton()"></div></div>
        <label style="margin-top:10px;">Color Activo</label><div class="flex-row"><div class="color-picker-wrapper"><input type="color" id="colorActive" value="#7c4dff" oninput="updateCurrentButton()"></div></div>
        <div class="input-group" style="margin-top:15px;"><label>Tipo de Renderizado</label><select id="editStyle" onchange="updateCurrentButton()"><option value="glass">Glassmorphism</option><option value="plain">Plano</option></select></div>
        <div class="input-group"><label>Efecto al Pulsar</label><select id="editClickEffect" onchange="updateCurrentButton()"><option value="down">Hundir (Shrink)</option><option value="up">Resaltar (Glow)</option></select></div>
    </div>
  </div>
</div>

<div id="fab" onclick="clickFab()">‚öô</div>

<script>
// --- Variables Globales ---
let elements = [];
let selectedBtn = null;
let clipboard = null;
let selectedIds = [];
let isDragging = false;
let isPotentialDrag = false;
let isSelecting = false;
let dragStart = { x: 0, y: 0 };
let selectionStart = { x: 0, y: 0 };
let learningMode = false;
let activeKeys = new Set(); 
let activeGamepadInputs = new Set();
let connectedGamepadIndex = null;
let socdEnabled = false;

// --- INPUT VIEWER ---
const MAX_HISTORY = 19;
let inputHistory = [{ frames: 1, inputs: ['N'], id: Date.now() }];
const DIRECTIONS = ['UP', 'DOWN', 'LEFT', 'RIGHT', 'U', 'D', 'L', 'R', 'F', 'B', 'N', '8', '2', '4', '6', '1', '3', '7', '9', 'ARRIBA', 'ABAJO', 'IZQUIERDA', 'DERECHA', 'ATRAS', 'ATR√ÅS', 'ADELANTE', '‚Üñ', '‚Üë', '‚Üó', '‚Üê', '‚Üí', '‚Üô', '‚Üì', '‚Üò'];
const SEMANTIC_UP = ['UP', 'U', 'ARRIBA', 'NUM8', '‚Üë', '‚Üñ', '‚Üó', 'ARROWUP'];
const SEMANTIC_DOWN = ['DOWN', 'ABAJO', 'NUM2', '‚Üì', '‚Üô', '‚Üò', 'ARROWDOWN']; 
const SEMANTIC_LEFT = ['LEFT', 'L', 'IZQUIERDA', 'ATRAS', 'BACK', 'NUM4', '‚Üê', '‚Üñ', '‚Üô', 'ARROWLEFT'];
const SEMANTIC_RIGHT = ['RIGHT', 'R', 'DERECHA', 'ADELANTE', 'FWD', 'NUM6', '‚Üí', '‚Üó', '‚Üò', 'ARROWRIGHT'];
let inputActivationTimes = {}; 
let isComboLearning = false;
let comboLearningStep = 0; 
let tempComboKeys = [];
let viewerConfig = { x: 50, y: 230, fontSize: 12, borderColor: '#7c4dff', backgroundColor: 'rgba(0, 0, 0, 0.85)', frameColor: '#ffffff', frameStroke: true, urls: { N:'' }, customCombos: [] };
let isDraggingViewer = false;
let viewerWasDragged = false; 
let viewerDragStart = { x: 0, y: 0 };

function initHoverEffect() {
    const panels = [
        { panel: 'rightPanel', glowId: 'glow-right' },
        { panel: 'leftPanel', glowId: 'glow-left' }
    ];
    panels.forEach(({ panel, glowId }) => {
        const panelEl = document.getElementById(panel);
        const glow = document.getElementById(glowId);
        const scrollArea = panelEl.querySelector('.panel-scroll');
        scrollArea.addEventListener('mousemove', (e) => {
            const card = e.target.closest('.control-card');
            if (card) {
                const top = card.offsetTop - 8;
                const left = card.offsetLeft - 8;
                const width = card.offsetWidth + 16;
                const height = card.offsetHeight + 16;
                glow.style.top = `${top}px`;
                glow.style.left = `${left}px`;
                glow.style.width = `${width}px`;
                glow.style.height = `${height}px`;
                glow.style.opacity = '1';
            }
        });
        scrollArea.addEventListener('mouseleave', () => { glow.style.opacity = '0'; });
    });
}

window.onload = () => {
    initHoverEffect();
    updateGlobalStatus();
};

window.addEventListener("gamepadconnected", (e) => { connectedGamepadIndex = e.gamepad.index; showToast(`Mando conectado: ${e.gamepad.id.substring(0, 20)}...`); updateGlobalStatus(); });
window.addEventListener("gamepaddisconnected", (e) => { showToast("Mando desconectado"); connectedGamepadIndex = null; updateGlobalStatus(); });

function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }

function updateGlobalStatus() {
  const el = document.getElementById('globalGamepadStatus');
  const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
  let found = false;
  for(let i=0; i<gamepads.length; i++) { if(gamepads[i]) { el.innerHTML = `‚úÖ <b>Conectado:</b><br>${gamepads[i].id.substring(0, 25)}...`; el.classList.add('connected'); found = true; break; } }
  if(!found) { el.innerHTML = `‚ùå No detectado.<br>Pulsa botones para despertar al mando.`; el.classList.remove('connected'); }
}

function gamepadLoop() {
  const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
  let frameActiveIds = new Set();
  for (let i = 0; i < gamepads.length; i++) {
    const gp = gamepads[i]; if (!gp) continue;
    if (learningMode && selectedBtn) {
      for (let b = 0; b < gp.buttons.length; b++) { if (gp.buttons[b].pressed) { selectedBtn.gamepadMap = { type: 'button', index: b, padIndex: i }; finishLearning(); requestAnimationFrame(gamepadLoop); return; } }
      for (let a = 0; a < gp.axes.length; a++) { if (Math.abs(gp.axes[a]) > 0.5) { selectedBtn.gamepadMap = { type: 'axis', index: a, value: gp.axes[a] > 0 ? 1 : -1, padIndex: i }; finishLearning(); requestAnimationFrame(gamepadLoop); return; } }
    }
    elements.forEach(btn => {
      if (!btn.gamepadMap) return;
      const map = btn.gamepadMap; let active = false;
      if (map.type === 'button' && gp.buttons[map.index]?.pressed) active = true;
      if (map.type === 'axis') { const val = gp.axes[map.index]; if (map.value > 0 && val > 0.3) active = true; if (map.value < 0 && val < -0.3) active = true; }
      if (active) frameActiveIds.add(btn.id);
    });
  }
  elements.forEach(btn => { if(btn.key && activeKeys.has(btn.key)) frameActiveIds.add(btn.id); });
  if (socdEnabled) { frameActiveIds = applySOCDCleaning(frameActiveIds); }
  let needsRender = false;
  frameActiveIds.forEach(id => { if (!activeGamepadInputs.has(id)) { activeGamepadInputs.add(id); needsRender = true; } });
  activeGamepadInputs.forEach(id => { if (!frameActiveIds.has(id)) { activeGamepadInputs.delete(id); needsRender = true; } });
  if (needsRender || socdEnabled) {
    elements.forEach(btn => {
        const el = document.querySelector(`[data-id="${btn.id}"]`);
        if(el) {
            if (!frameActiveIds.has(btn.id)) { 
                el.style.background = btn.colorInactive; 
                el.classList.remove('active', 'effect-up', 'effect-down'); 
                if (btn.style === 'plain') el.classList.add('plain');
                // Re-aplicar imagen si existe
                if(btn.image) el.style.backgroundImage = `url(${btn.image})`;
            } 
            else { applyStyle(el, btn); }
        }
    });
  }
  processInputViewerFrame(frameActiveIds);
  requestAnimationFrame(gamepadLoop);
}
requestAnimationFrame(gamepadLoop);

function applySOCDCleaning(activeIds) {
    let hasUp = false, hasDown = false, hasLeft = false, hasRight = false;
    activeIds.forEach(id => {
        const btn = elements.find(b => b.id === id);
        if (btn) {
            const txt = (btn.text || '').toUpperCase(); const key = (btn.key || '').toUpperCase();
            if (SEMANTIC_UP.includes(txt) || SEMANTIC_UP.includes(key)) hasUp = true;
            if (SEMANTIC_DOWN.includes(txt) || SEMANTIC_DOWN.includes(key)) hasDown = true;
            if (SEMANTIC_LEFT.includes(txt) || SEMANTIC_LEFT.includes(key)) hasLeft = true;
            if (SEMANTIC_RIGHT.includes(txt) || SEMANTIC_RIGHT.includes(key)) hasRight = true;
        }
    });
    const cancelVertical = hasUp && hasDown; const cancelHorizontal = hasLeft && hasRight;
    if (!cancelVertical && !cancelHorizontal) return activeIds; 
    const cleanedIds = new Set();
    activeIds.forEach(id => {
        const btn = elements.find(b => b.id === id); if (!btn) return;
        const txt = (btn.text || '').toUpperCase(); const key = (btn.key || '').toUpperCase();
        let isDirty = false;
        if (cancelVertical) { if (SEMANTIC_UP.includes(txt) || SEMANTIC_UP.includes(key)) isDirty = true; if (SEMANTIC_DOWN.includes(txt) || SEMANTIC_DOWN.includes(key)) isDirty = true; }
        if (cancelHorizontal) { if (SEMANTIC_LEFT.includes(txt) || SEMANTIC_LEFT.includes(key)) isDirty = true; if (SEMANTIC_RIGHT.includes(txt) || SEMANTIC_RIGHT.includes(key)) isDirty = true; }
        if (!isDirty) cleanedIds.add(id);
    });
    return cleanedIds;
}

function processInputViewerFrame(activeIds) {
    let rawInputs = [];
    activeIds.forEach(id => {
        const btn = elements.find(b => b.id === id);
        if(btn) {
            if (btn.macro && btn.macro.trim() !== '') { const targets = btn.macro.split(',').map(s => s.trim().toUpperCase()); rawInputs.push(...targets); } 
            else { rawInputs.push((btn.text || '').toUpperCase()); }
        }
    });
    rawInputs = [...new Set(rawInputs)];
    let processedInputs = []; let inputsToConsume = [...rawInputs]; 
    if (viewerConfig.customCombos && viewerConfig.customCombos.length > 0) {
        viewerConfig.customCombos.forEach(combo => {
            const key1 = combo.keys[0]; const key2 = combo.keys[1];
            if (inputsToConsume.includes(key1) && inputsToConsume.includes(key2)) {
                processedInputs.push(`COMBO_ID:${combo.id}`);
                const idx1 = inputsToConsume.indexOf(key1); if (idx1 > -1) inputsToConsume.splice(idx1, 1);
                const idx2 = inputsToConsume.indexOf(key2); if (idx2 > -1) inputsToConsume.splice(idx2, 1);
            }
        });
    }
    processedInputs = [...processedInputs, ...inputsToConsume];
    const now = Date.now();
    processedInputs.forEach(input => { if (!inputActivationTimes[input]) inputActivationTimes[input] = now; });
    Object.keys(inputActivationTimes).forEach(key => { if (!processedInputs.includes(key)) delete inputActivationTimes[key]; });
    let finalInputs = processedInputs.length === 0 ? ['N'] : processedInputs;
    finalInputs.sort((a, b) => {
        const isDirection = (key) => { if (DIRECTIONS.includes(key)) return true; if (key.startsWith('COMBO_ID:')) { const id = parseInt(key.split(':')[1]); const combo = viewerConfig.customCombos.find(c => c.id === id); if (combo && combo.keys.every(k => DIRECTIONS.includes(k))) return true; } return false; };
        const isDirA = isDirection(a); const isDirB = isDirection(b);
        if (isDirA && !isDirB) return -1; if (!isDirA && isDirB) return 1;
        if (!isDirA && !isDirB) { const timeA = inputActivationTimes[a] || 0; const timeB = inputActivationTimes[b] || 0; if (timeA !== timeB) return timeA - timeB; }
        return a.localeCompare(b);
    });
    const currentInputString = finalInputs.join('+');
    if (inputHistory.length === 0) { inputHistory.push({ frames: 1, inputs: finalInputs, id: Date.now() }); } 
    else {
        const topEntry = inputHistory[0]; const topInputString = topEntry.inputs.join('+');
        if (currentInputString === topInputString) { topEntry.frames++; updateTopRowDisplay(topEntry); } 
        else { const newEntry = { frames: 1, inputs: finalInputs, id: Date.now() }; inputHistory.unshift(newEntry); if (inputHistory.length > MAX_HISTORY) inputHistory.pop(); renderInputHistory(); document.getElementById('inputDisplayContainer').style.display = 'block'; }
    }
}

function updateTopRowDisplay(entry) {
    const container = document.getElementById('inputDisplayContainer'); if (!container.firstElementChild) return;
    const frameEl = container.firstElementChild.querySelector('.frame-count');
    if (frameEl) { frameEl.innerText = entry.frames > 99 ? '99+' : entry.frames; frameEl.style.color = viewerConfig.frameColor || '#ffffff'; frameEl.style.textShadow = viewerConfig.frameStroke ? '-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000' : 'none'; }
}

function renderInputHistory() {
    const container = document.getElementById('inputDisplayContainer'); container.innerHTML = ''; 
    inputHistory.forEach(entry => {
        const row = document.createElement('div'); row.className = 'history-row';
        const frames = document.createElement('div'); frames.className = 'frame-count'; frames.style.fontSize = viewerConfig.fontSize + 'px'; frames.innerText = entry.frames > 99 ? '99+' : entry.frames; frames.style.color = viewerConfig.frameColor || '#ffffff'; frames.style.textShadow = viewerConfig.frameStroke ? '-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000' : 'none';
        row.appendChild(frames);
        entry.inputs.forEach(inputKey => {
            const div = document.createElement('div'); div.className = 'input-icon';
            if (inputKey.startsWith('COMBO_ID:')) {
                const comboId = parseInt(inputKey.split(':')[1]); const combo = viewerConfig.customCombos.find(c => c.id === comboId);
                if (combo && combo.url) { const img = document.createElement('img'); img.src = combo.url; div.appendChild(img); } 
                else { const span = document.createElement('div'); span.className = 'fallback-icon'; span.innerText = combo ? (combo.keys[0]+'+'+combo.keys[1]) : '?'; div.appendChild(span); }
            } else { renderIconOrText(div, inputKey); }
            row.appendChild(div);
        });
        container.appendChild(row);
    });
}

function renderIconOrText(container, key) {
    const url = viewerConfig.urls[key];
    if (url) { const img = document.createElement('img'); img.src = url; container.appendChild(img); } 
    else { const span = document.createElement('div'); span.className = 'fallback-icon'; span.innerText = key === 'N' ? '.' : key; container.appendChild(span); }
}

function clickFab() { const panel = document.getElementById('rightPanel'); closeEditor(); if (panel.classList.contains('open')) { switchRightTab('general'); } else { panel.classList.add('open'); switchRightTab('general'); } }
function closeRightPanel() { document.getElementById('rightPanel').classList.remove('open'); }
function switchRightTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    document.querySelectorAll('.panel-page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + tabName).classList.add('active');
    if(tabName === 'viewer') { refreshAttackInputs(); renderCustomCombosList(); }
    document.getElementById('glow-right').style.opacity = '0';
}
function updateBorderColor(val) { viewerConfig.borderColor = val; document.getElementById('inputDisplayContainer').style.borderLeftColor = val; saveViewerConfig(); }
function updateViewerBg(val) { viewerConfig.backgroundColor = val; document.getElementById('inputDisplayContainer').style.background = val; saveViewerConfig(); }
function updateFrameColor(val) { viewerConfig.frameColor = val; document.getElementById('viewerFrameColorPicker').value = val; document.getElementById('viewerFrameColorText').value = val; saveViewerConfig(); }

function startComboLearning() { isComboLearning = true; comboLearningStep = 1; tempComboKeys = []; showToast("MODO COMBOS: Pulsa el PRIMER bot√≥n en la pantalla."); closeRightPanel(); }
function handleComboSelection(btn) {
    if (!isComboLearning) return false;
    if (comboLearningStep === 2 && tempComboKeys[0] === btn.text.toUpperCase()) { showToast("Elige un bot√≥n distinto."); return true; }
    tempComboKeys.push(btn.text.toUpperCase());
    if (comboLearningStep === 1) { comboLearningStep = 2; showToast(`Bot√≥n 1: ${btn.text}. Pulsa el SEGUNDO bot√≥n.`); } 
    else if (comboLearningStep === 2) {
        const newCombo = { id: Date.now(), keys: tempComboKeys, url: '' };
        if (!viewerConfig.customCombos) viewerConfig.customCombos = [];
        viewerConfig.customCombos.push(newCombo); showToast(`Diagonal creada: ${tempComboKeys.join(" + ")}`);
        isComboLearning = false; comboLearningStep = 0;
        document.getElementById('rightPanel').classList.add('open'); switchRightTab('viewer');
        setTimeout(() => { document.getElementById('customCombosContainer').lastElementChild?.scrollIntoView({ behavior: 'smooth' }); saveViewerConfig(); }, 100);
    }
    return true; 
}
function renderCustomCombosList() {
    const container = document.getElementById('customCombosContainer'); container.innerHTML = '';
    if (!viewerConfig.customCombos) viewerConfig.customCombos = [];
    viewerConfig.customCombos.forEach((combo, index) => {
        const div = document.createElement('div'); div.className = 'combo-item';
        const deleteBtn = document.createElement('div'); deleteBtn.className = 'combo-delete'; deleteBtn.innerText = '√ó'; deleteBtn.onclick = () => deleteCombo(index);
        const title = document.createElement('div'); title.className = 'combo-keys'; title.innerText = `${combo.keys[0]} + ${combo.keys[1]}`;
        const inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = 'URL Imagen Diagonal'; inp.style.fontSize = '12px'; inp.style.padding = '8px'; inp.value = combo.url || '';
        inp.oninput = (e) => { combo.url = e.target.value; saveViewerConfig(); };
        div.appendChild(deleteBtn); div.appendChild(title); div.appendChild(inp); container.appendChild(div);
    });
}
function deleteCombo(index) { viewerConfig.customCombos.splice(index, 1); saveViewerConfig(); renderCustomCombosList(); }

// 2. Mejora: L√≥gica Sincronizaci√≥n Fondo
function syncBgPicker(val) {
    document.getElementById('bgInput').value = val;
    document.body.style.background = val;
    saveToStorage();
}
function syncBgText(val) {
    if (val.match(/^#[0-9A-F]{6}$/i)) {
        document.getElementById('bgInputPicker').value = val;
    }
    document.body.style.background = val;
    saveToStorage();
}

function openEditor(btn = null) {
  selectedBtn = btn; updateLearningButtonUI();
  document.querySelectorAll('.input-btn').forEach(el => el.classList.remove('editing'));
  const isMulti = selectedIds.length > 1;
  const title = document.getElementById('editorTitle');
  if (title) title.innerText = isMulti ? `Editar Selecci√≥n (${selectedIds.length})` : 'Editar Bot√≥n';
  document.getElementById('leftPanel').classList.add('open'); closeRightPanel(); 
  document.getElementById('editText').disabled = isMulti; document.getElementById('editKey').disabled = isMulti; document.getElementById('editMacro').disabled = isMulti; document.getElementById('btnAssignGamepad').disabled = isMulti;
  document.getElementById('editImage').disabled = isMulti;
  if (btn) {
    const el = document.querySelector(`[data-id="${btn.id}"]`); if(el) el.classList.add('editing');
    document.getElementById('editImage').value = btn.image || '';
    document.getElementById('editText').value = btn.text || ''; 
    document.getElementById('editKey').value = btn.key || '';
    document.getElementById('editSize').value = btn.size || 80; 
    document.getElementById('colorInactive').value = btn.colorInactive || '#1e1e32';
    document.getElementById('colorActive').value = btn.colorActive || '#7c4dff'; 
    document.getElementById('editStyle').value = btn.style || 'glass';
    document.getElementById('editClickEffect').value = btn.clickEffect || 'down'; 
    document.getElementById('editMacro').value = btn.macro || '';
    updateGamepadStatusText(btn.gamepadMap);
  }
}
function closeEditor() { document.getElementById('leftPanel').classList.remove('open'); document.querySelectorAll('.input-btn').forEach(el => el.classList.remove('editing')); selectedBtn = null; learningMode = false; updateLearningButtonUI(); document.getElementById('glow-left').style.opacity = '0'; }

function addNewButton() {
  const size = 90;
  const newBtn = { id: Date.now(), x: innerWidth/2 - size/2, y: innerHeight/2 - size/2, size: size, text: 'LP', key: '', colorInactive: '#1e1e32', colorActive: '#7c4dff', style: 'glass', clickEffect: 'down', macro: '', gamepadMap: null, image: '' };
  elements.push(newBtn); renderButton(newBtn); clearSelection(); selectedIds = [newBtn.id]; updateSelectionVisuals(); openEditor(newBtn); saveToStorage();
}

function updateCurrentButton() {
  if (selectedIds.length === 0) return;
  const size = parseInt(document.getElementById('editSize').value) || 80;
  const colorInactive = document.getElementById('colorInactive').value;
  const colorActive = document.getElementById('colorActive').value;
  const style = document.getElementById('editStyle').value;
  const clickEffect = document.getElementById('editClickEffect').value;
  const text = document.getElementById('editText').value;
  const key = document.getElementById('editKey').value.toLowerCase();
  const macro = document.getElementById('editMacro').value;
  const imgUrl = document.getElementById('editImage').value;
  const isMulti = selectedIds.length > 1;
  selectedIds.forEach(id => {
      const btn = elements.find(b => b.id === id);
      if(btn) { 
          btn.size = size; btn.colorInactive = colorInactive; btn.colorActive = colorActive; 
          btn.style = style; btn.clickEffect = clickEffect; 
          if (!isMulti) { btn.text = text; btn.key = key; btn.macro = macro; btn.image = imgUrl; } 
          updateButtonVisual(btn); 
      }
  });
  refreshAttackInputs(); saveToStorage();
}

function startLearning() { if(!selectedBtn || selectedIds.length > 1) return; learningMode = true; updateLearningButtonUI(); }
function clearGamepadMapping() { if(!selectedBtn) return; selectedBtn.gamepadMap = null; updateGamepadStatusText(null); saveToStorage(); }
function finishLearning() { learningMode = false; updateLearningButtonUI(); updateGamepadStatusText(selectedBtn.gamepadMap); saveToStorage(); }
function updateLearningButtonUI() { const btn = document.getElementById('btnAssignGamepad'); if(learningMode) { btn.textContent = "Esperando pulsaci√≥n..."; btn.classList.add('learning'); } else { btn.textContent = "Detectar Input"; btn.classList.remove('learning'); } }
function updateGamepadStatusText(map) { const txt = document.getElementById('gamepadStatusText'); if (!map) { txt.textContent = "Ninguno asignado"; txt.style.color = "#aaa"; } else { txt.innerHTML = map.type === 'button' ? `üéÆ Bot√≥n <b style="color:#fff">${map.index}</b>` : `üïπÔ∏è Eje <b style="color:#fff">${map.index}</b> [${map.value > 0 ? '+' : '-'}]`; txt.style.color = "#ccc"; } }

function renderButton(btn) {
  const el = document.createElement('div'); el.className = 'input-btn'; el.dataset.id = btn.id; el.textContent = btn.image ? '' : (btn.text || ''); 
  const closeBadge = document.createElement('div'); closeBadge.className = 'delete-badge'; closeBadge.innerHTML = '√ó'; closeBadge.onmousedown = (e) => e.stopPropagation(); closeBadge.onclick = (e) => { e.stopPropagation(); deleteButton(btn.id); };
  el.appendChild(closeBadge); 
  applyStyle(el, btn); 
  el.style.width = el.style.height = btn.size + 'px'; el.style.left = btn.x + 'px'; el.style.top = btn.y + 'px';
  el.onmousedown = (e) => startDrag(e, btn); el.onmouseup = (e) => endDrag(e, btn);
  document.getElementById('canvas').appendChild(el);
}

function updateButtonVisual(btn) {
  const el = document.querySelector(`[data-id="${btn.id}"]`); if (!el) return;
  const badge = el.querySelector('.delete-badge'); 
  // 3. Mejora: L√≥gica Renderizado Imagen
  el.textContent = btn.image ? '' : (btn.text || ''); 
  if(badge) el.appendChild(badge);
  el.style.width = el.style.height = btn.size + 'px'; el.style.left = btn.x + 'px'; el.style.top = btn.y + 'px'; 
  applyStyle(el, btn);
}

function applyStyle(el, btn) {
  const isPressed = activeKeys.has(btn.key) || activeGamepadInputs.has(btn.id);
  if (isPressed) { el.style.background = btn.colorActive; el.classList.add('active'); } else { el.style.background = btn.colorInactive; el.classList.remove('active'); }
  el.style.borderColor = btn.colorActive + '88';
  
  // Aplicar imagen de fondo si existe
  if(btn.image) {
    el.style.backgroundImage = `url(${btn.image})`;
    el.style.backgroundSize = 'contain';
    el.style.backgroundRepeat = 'no-repeat';
    el.style.backgroundPosition = 'center';
  } else {
    el.style.backgroundImage = 'none';
  }

  if (btn.style === 'plain') el.classList.add('plain'); else el.classList.remove('plain');
  el.classList.remove('effect-up', 'effect-down'); el.classList.add(btn.clickEffect === 'up' ? 'effect-up' : 'effect-down');
  if (selectedIds.includes(btn.id)) el.classList.add('selected-multi'); else el.classList.remove('selected-multi');
}

function startDrag(e, btn) {
  if (e.button !== 0) return; e.stopPropagation();
  if (isComboLearning) { handleComboSelection(btn); return; }
  const isMultiSelect = e.shiftKey || e.ctrlKey;
  if (isMultiSelect) { if (selectedIds.includes(btn.id)) { selectedIds = selectedIds.filter(id => id !== btn.id); if (selectedIds.length === 0) closeEditor(); else openEditor(elements.find(b => b.id === selectedIds[selectedIds.length - 1])); } else { selectedIds.push(btn.id); openEditor(btn); } } 
  else { if (!selectedIds.includes(btn.id)) { selectedIds = [btn.id]; openEditor(btn); } else { openEditor(btn); } }
  updateSelectionVisuals(); isPotentialDrag = true; isDragging = false; dragStart = { x: e.clientX, y: e.clientY };
}
const viewerEl = document.getElementById('inputDisplayContainer');
viewerEl.onmousedown = (e) => { if(e.button !== 0) return; isDraggingViewer = true; viewerWasDragged = false; viewerDragStart = { x: e.clientX - viewerEl.offsetLeft, y: e.clientY - viewerEl.offsetTop }; e.stopPropagation(); };
document.getElementById('canvas').onmousedown = (e) => {
  if (e.button !== 0 || e.target.id !== 'canvas') return;
  if (isComboLearning) { isComboLearning = false; comboLearningStep = 0; showToast("Cancelado"); return; }
  clearSelection(); closeEditor(); closeRightPanel(); isSelecting = true; selectionStart = { x: e.clientX, y: e.clientY };
  const box = document.getElementById('selectionBox'); box.style.left = e.clientX + 'px'; box.style.top = e.clientY + 'px'; box.style.width = '0px'; box.style.height = '0px'; box.style.display = 'block';
};
document.onmousemove = (e) => {
  if (isPotentialDrag) {
    const dx = e.clientX - dragStart.x; const dy = e.clientY - dragStart.y;
    if (Math.abs(dx) > 5 || Math.abs(dy) > 5) isDragging = true;
    if (isDragging) { selectedIds.forEach(id => { const btnObj = elements.find(b => b.id === id); if (btnObj) { btnObj.x += dx; btnObj.y += dy; const el = document.querySelector(`[data-id="${id}"]`); if (el) { el.style.left = btnObj.x + 'px'; el.style.top = btnObj.y + 'px'; } } }); dragStart = { x: e.clientX, y: e.clientY }; }
  }
  if (isDraggingViewer) { viewerWasDragged = true; const nx = e.clientX - viewerDragStart.x; const ny = e.clientY - viewerDragStart.y; viewerEl.style.left = nx + 'px'; viewerEl.style.top = ny + 'px'; viewerConfig.x = nx; viewerConfig.y = ny; }
  if (isSelecting) {
    const currentX = e.clientX; const currentY = e.clientY;
    const left = Math.min(selectionStart.x, currentX); const top = Math.min(selectionStart.y, currentY); const width = Math.abs(currentX - selectionStart.x); const height = Math.abs(currentY - selectionStart.y);
    const box = document.getElementById('selectionBox'); box.style.left = left + 'px'; box.style.top = top + 'px'; box.style.width = width + 'px'; box.style.height = height + 'px';
    elements.forEach(btn => { const btnEl = document.querySelector(`[data-id="${btn.id}"]`); if(!btnEl) return; const btnRect = btnEl.getBoundingClientRect(); if (left < btnRect.right && left + width > btnRect.left && top < btnRect.bottom && top + height > btnRect.top) { if (!selectedIds.includes(btn.id)) selectedIds.push(btn.id); } else { if (!e.shiftKey && !e.ctrlKey) selectedIds = selectedIds.filter(id => id !== btn.id); } });
    updateSelectionVisuals();
  }
};
function endDrag(e, btn) { if (isPotentialDrag) { if (!isDragging) openEditor(btn); else saveToStorage(); } isPotentialDrag = false; isDragging = false; }
document.onmouseup = () => { if (isDragging) { isDragging = false; saveToStorage(); } if (isDraggingViewer) { isDraggingViewer = false; if (!viewerWasDragged) { closeEditor(); document.getElementById('rightPanel').classList.add('open'); switchRightTab('viewer'); } saveViewerConfig(); } isPotentialDrag = false; if (isSelecting) { isSelecting = false; document.getElementById('selectionBox').style.display = 'none'; if(selectedIds.length > 0) openEditor(elements.find(b => b.id === selectedIds[selectedIds.length - 1])); } };
function clearSelection() { selectedIds = []; updateSelectionVisuals(); }
function updateSelectionVisuals() { document.querySelectorAll('.input-btn').forEach(el => { const id = parseInt(el.dataset.id); if (selectedIds.includes(id)) el.classList.add('selected-multi'); else el.classList.remove('selected-multi'); }); }

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeRightPanel(); closeEditor(); if (isComboLearning) { isComboLearning = false; comboLearningStep = 0; showToast("Cancelado"); } clearSelection(); return; }
  if (e.target.tagName === 'INPUT') return;
  const k = e.key.toLowerCase(); if (!activeKeys.has(k)) { activeKeys.add(k); elements.forEach(btn => { if (btn.key === k) { const el = document.querySelector(`[data-id="${btn.id}"]`); if(el) applyStyle(el, btn); } }); }
  if (e.key === 'Delete' && selectedIds.length > 0) { if (e.code === 'Delete') { e.preventDefault(); selectedIds.forEach(id => deleteButton(id)); clearSelection(); } }
  if (!e.ctrlKey) return;
  if (e.key === 'c' && selectedIds.length > 0) { const primaryId = selectedIds[selectedIds.length - 1]; const btn = elements.find(b => b.id === primaryId); if (btn) { clipboard = { ...btn, gamepadMap: null }; const fab = document.getElementById('fab'); fab.style.background = '#fff'; setTimeout(() => fab.style.background = '', 200); } e.preventDefault(); }
  if (e.key === 'v' && clipboard) { const nuevo = { ...clipboard, id: Date.now(), x: clipboard.x + 30, y: clipboard.y + 30 }; elements.push(nuevo); renderButton(nuevo); saveToStorage(); e.preventDefault(); }
});
document.addEventListener('keyup', (e) => { const k = e.key.toLowerCase(); if (activeKeys.has(k)) { activeKeys.delete(k); elements.forEach(btn => { if (btn.key === k) { const el = document.querySelector(`[data-id="${btn.id}"]`); if(el) applyStyle(el, btn); } }); } });

function deleteButton(id) { elements = elements.filter(b => b.id !== id); selectedIds = selectedIds.filter(sid => sid !== id); document.querySelector(`[data-id="${id}"]`)?.remove(); if (selectedBtn && selectedBtn.id === id) closeEditor(); saveToStorage(); }

function applyGlobalStyle() { const style = document.getElementById('globalStyle').value; elements.forEach(btn => { btn.style = style; const el = document.querySelector(`[data-id="${btn.id}"]`); if (el) applyStyle(el, btn); }); saveToStorage(); }
function saveSOCDConfig() { socdEnabled = document.getElementById('socdToggle').checked; saveToStorage(); }

function saveViewerConfig() { viewerConfig.fontSize = parseInt(document.getElementById('viewerFontSize').value) || 12; viewerConfig.frameStroke = document.getElementById('viewerFrameStroke').checked; viewerConfig.urls['N'] = document.getElementById('url_N').value; document.querySelectorAll('.custom-url-input').forEach(inp => { viewerConfig.urls[inp.dataset.key] = inp.value; }); localStorage.setItem('fgcViewerConfig', JSON.stringify(viewerConfig)); renderInputHistory(); }
function loadViewerConfig(configOverride = null) {
    let data = configOverride; if (!data) { const str = localStorage.getItem('fgcViewerConfig'); if(str) { try { data = JSON.parse(str); } catch(e) {} } }
    if(data) {
        viewerConfig = { ...viewerConfig, ...data }; const el = document.getElementById('inputDisplayContainer'); el.style.left = viewerConfig.x + 'px'; el.style.top = viewerConfig.y + 'px'; el.style.borderLeftColor = viewerConfig.borderColor || '#7c4dff'; el.style.background = viewerConfig.backgroundColor || 'rgba(0, 0, 0, 0.85)';
        document.getElementById('viewerFontSize').value = viewerConfig.fontSize; document.getElementById('viewerBorderColorPicker').value = viewerConfig.borderColor; document.getElementById('viewerBorderColorText').value = viewerConfig.borderColor; document.getElementById('viewerBgColorPicker').value = viewerConfig.backgroundColor || '#000000'; document.getElementById('viewerBgColorText').value = viewerConfig.backgroundColor || 'rgba(0, 0, 0, 0.85)';
        document.getElementById('viewerFrameColorPicker').value = viewerConfig.frameColor || '#ffffff'; document.getElementById('viewerFrameColorText').value = viewerConfig.frameColor || '#ffffff'; document.getElementById('viewerFrameStroke').checked = (viewerConfig.frameStroke !== undefined) ? viewerConfig.frameStroke : true;
        const nInput = document.getElementById('url_N'); if(nInput) nInput.value = viewerConfig.urls['N'] || ''; renderCustomCombosList(); refreshAttackInputs();
    }
}
function resetViewerPos() { const el = document.getElementById('inputDisplayContainer'); el.style.left = '50px'; el.style.top = '230px'; viewerConfig.x = 50; viewerConfig.y = 230; saveViewerConfig(); }
function refreshAttackInputs() {
    const container = document.getElementById('attackUrlContainer'); container.innerHTML = ''; const uniqueTexts = new Set();
    elements.forEach(btn => { const t = (btn.text || '').toUpperCase(); if(t !== 'N' && t.length > 0) uniqueTexts.add(t); });
    uniqueTexts.forEach(txt => {
        const wrap = document.createElement('div'); wrap.style.marginTop = '10px'; wrap.className = 'input-group';
        const label = document.createElement('label'); label.innerText = `Icono para "${txt}"`;
        const inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = 'URL imagen'; inp.className = 'custom-url-input'; inp.dataset.key = txt; inp.value = viewerConfig.urls[txt] || ''; inp.oninput = saveViewerConfig;
        wrap.appendChild(label); wrap.appendChild(inp); container.appendChild(wrap);
    });
}
function copyTextToClipboard(text, successMsg, fallbackMsg) { if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(text).then(() => showToast(successMsg)).catch(() => manualCopy(text, fallbackMsg)); } else manualCopy(text, fallbackMsg); }
function manualCopy(text, msg) { const input = document.createElement('textarea'); input.value = text; document.body.appendChild(input); input.select(); document.execCommand('copy'); document.body.removeChild(input); showToast(msg); }

document.getElementById('importInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    const str = this.value.trim(); if (!str) return;
    try {
      const data = JSON.parse(str); if (!data.elements) throw new Error('Formato inv√°lido');
      document.body.style.background = data.bg || 'transparent'; document.getElementById('bgInput').value = data.bg || 'transparent'; elements = data.elements || []; document.getElementById('canvas').innerHTML = ''; elements.forEach(renderButton); saveToStorage();
      if (data.viewerConfig) { loadViewerConfig(data.viewerConfig); saveViewerConfig(); }
      this.value = '¬°Configuraci√≥n Cargada!'; this.style.borderColor = '#0f0'; setTimeout(() => { this.value = ''; this.style.borderColor = ''; }, 1500);
    } catch(err) { this.value = 'Error: JSON Inv√°lido'; this.style.borderColor = '#f00'; showToast('Error: Formato JSON Inv√°lido'); setTimeout(() => { this.value = ''; this.style.borderColor = ''; }, 3000); }
  }
});
function exportConfig() { const data = { bg: document.body.style.background, elements, viewerConfig: viewerConfig, socdEnabled: socdEnabled }; copyTextToClipboard(JSON.stringify(data), '‚úÖ Configuraci√≥n copiada', '¬°Copiado (fallback)!'); }
function clearAll() { showToast('‚ö†Ô∏è Pulsa otra vez para borrar TODO.'); if (window.clearAllConfirmed) { elements = []; document.getElementById('canvas').innerHTML = ''; localStorage.removeItem('fgcInputDisplayV2'); localStorage.removeItem('fgcViewerConfig'); viewerConfig.urls = { N:'' }; viewerConfig.customCombos = []; socdEnabled = false; document.getElementById('socdToggle').checked = false; closeEditor(); window.clearAllConfirmed = false; showToast('üóëÔ∏è ¬°Borrado completo!'); resetViewerPos(); loadViewerConfig(); } else { window.clearAllConfirmed = true; setTimeout(() => window.clearAllConfirmed = false, 3000); } }
function saveToStorage() { const data = { bg: document.body.style.background, elements, socdEnabled: socdEnabled }; localStorage.setItem('fgcInputDisplayV2', JSON.stringify(data)); }
function loadFromStorage() { const str = localStorage.getItem('fgcInputDisplayV2'); if (!str) return; try { const data = JSON.parse(str); document.body.style.background = data.bg || 'transparent'; document.getElementById('bgInput').value = data.bg || 'transparent'; if(data.bg && data.bg.match(/^#[0-9A-F]{6}$/i)) document.getElementById('bgInputPicker').value = data.bg; elements = data.elements || []; elements.forEach(renderButton); socdEnabled = data.socdEnabled || false; const socdToggle = document.getElementById('socdToggle'); if(socdToggle) socdToggle.checked = socdEnabled; } catch(e) {} }

loadFromStorage();
loadViewerConfig();
</script>
</body>
</html>
